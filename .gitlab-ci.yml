default:
  image: docker:24.0
  before_script:
    - docker info

variables:
  DOCKER_HOST: unix:///var/run/docker.sock

stages:
  - build
  - deploy


buildfrontend:
  stage: build
  script:
    - docker build -t faipp-frontend front/

deployfrontend:
  stage: deploy
  before_script:
    - docker stop faipp-frontend-$CI_PROJECT_NAME || true
    - docker rm faipp-frontend-$CI_PROJECT_NAME || true
  script:
    - docker run --name faipp-frontend-$CI_PROJECT_NAME -d 
      -e VIRTUAL_HOST=faipp.rezel.net,fai.rezel.net -e LETSENCRYPT_HOST=faipp.rezel.net,fai.rezel.net
      -v /etc/ssl/certs:/etc/ssl/certs:ro
      --network reverse_default --restart unless-stopped
      faipp-frontend:latest

buildinfra:
  stage: build
  script:
    - cat $ENV_VARIABLES > .env
    - docker compose up -d --remove-orphans

buildbackend:
  stage: build
  script:
    - cat $ENV_BACK > back/.env
    - docker build -t faipp-backend back/

deploybackend:
  stage: deploy
  before_script:
    - docker stop faipp-backend-$CI_PROJECT_NAME || true
    - docker rm faipp-backend-$CI_PROJECT_NAME || true
  script:
    - docker run --name faipp-backend-$CI_PROJECT_NAME -d 
      -e VIRTUAL_HOST=api.faipp.rezel.net,api.fai.rezel.net -e LETSENCRYPT_HOST=api.faipp.rezel.net,api.fai.rezel.net
      -v /etc/ssl/certs:/etc/ssl/certs:ro
      --network reverse_default --restart unless-stopped
      faipp-backend:latest
